name: Release

permissions:
  contents: write
  packages: write

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.VERSION }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi
        
    - name: Create Release
      id: create_release
      uses: ncipollo/release-action@v1
      with:
        tag: ${{ steps.get_version.outputs.VERSION }}
        name: "Jellyfinå·¥å…·ç®± ${{ steps.get_version.outputs.VERSION }}"
        token: ${{ secrets.GITHUB_TOKEN }}
        body: |
          ## ðŸš€ Jellyfinå·¥å…·ç®± ${{ steps.get_version.outputs.VERSION }}
          
          ðŸ¤– **æœ¬ç‰ˆæœ¬ç”± Claude Code åˆ›å»º** - ä½¿ç”¨ AI åŠ©æ‰‹è¿›è¡Œå®Œæ•´å¼€å‘
          
          ### ðŸ“¦ ä¸‹è½½
          
          - **Windows**: ä¸‹è½½ `jtools-windows.zip`
          - **macOS**: ä¸‹è½½ `jtools-macos.zip` 
          - **Linux**: ä¸‹è½½ `jtools-linux.zip`
          - **é€šç”¨JAR**: ä¸‹è½½ `jtools-${{ steps.get_version.outputs.VERSION }}.jar`
          
          ### ðŸŽ¯ ä¸»è¦åŠŸèƒ½
          
          - ðŸŽ¬ å¯¼å…¥å¯¼å‡ºJellyfinå–œçˆ±çš„ç”µå½±å’Œæ¼”å‘˜
          - ðŸ”„ è·¨æœåŠ¡å™¨æ™ºèƒ½è¿ç§»
          - ðŸ” é‡å¤ç”µå½±æ£€æµ‹å’Œç®¡ç†
          - ðŸ‘ï¸ å¯¼å‡ºå†…å®¹å¯è§†åŒ–é¢„è§ˆ
          - ðŸ“± é«˜åˆ†è¾¨çŽ‡å±å¹•å®Œç¾Žé€‚é…
          - ðŸŒ è·¨å¹³å°æ”¯æŒ (Windows, macOS, Linux)
          
          ### ðŸ› ï¸ æŠ€æœ¯ç‰¹è‰²
          
          - Kotlin Multiplatform æž¶æž„
          - Compose Desktop çŽ°ä»£UI
          - Material Design 3 è®¾è®¡è¯­è¨€
          - AI é©±åŠ¨çš„ä»£ç è´¨é‡
          
          ### ðŸš¦ ä½¿ç”¨æ–¹æ³•
          
          #### GUIç‰ˆæœ¬ï¼ˆæŽ¨èï¼‰
          ```bash
          # è§£åŽ‹åŽè¿è¡Œ
          ./jellyfin-tools-gui
          ```
          
          #### CLIç‰ˆæœ¬
          ```bash
          # æµ‹è¯•è¿žæŽ¥
          ./jellyfin-tools-cli test -s http://your-server:8096 -t your-token
          
          # å¯¼å‡ºæ•°æ®
          ./jellyfin-tools-cli export -s http://your-server:8096 -t your-token -o favorites.json
          
          # å¯¼å…¥æ•°æ®
          ./jellyfin-tools-cli import -s http://your-server:8096 -t your-token -i favorites.json
          ```
          
          ---
          
          **å®Œæ•´æ–‡æ¡£**: [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
          
          **åé¦ˆé—®é¢˜**: [Issues](https://github.com/${{ github.repository }}/issues)
        draft: false
        prerelease: false

  build-cross-platform:
    needs: create-release
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            platform: linux
            executable-suffix: ""
            archive-suffix: "tar.gz"
          - os: windows-latest
            platform: windows
            executable-suffix: ".exe"
            archive-suffix: "zip"
          - os: macos-latest
            platform: macos
            executable-suffix: ""
            archive-suffix: "zip"
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Grant execute permission for gradlew (Unix)
      if: matrix.os != 'windows-latest'
      run: chmod +x gradlew
      
    - name: Simplify build for release
      run: |
        # Create a simplified build.gradle.kts for release builds
        cp build.gradle.kts build.gradle.kts.backup
        cat > build.gradle.kts << 'EOF'
        plugins {
            kotlin("multiplatform") version "1.9.20"
            kotlin("plugin.serialization") version "1.9.20"
            id("org.jetbrains.compose") version "1.5.11"
        }

        group = "com.jtools"
        version = "1.0.0"

        repositories {
            mavenCentral()
            google()
            maven("https://maven.pkg.jetbrains.space/public/p/compose/dev")
        }

        kotlin {
            jvm {
                jvmToolchain(17)
                withJava()
            }

            sourceSets {
                val commonMain by getting {
                    dependencies {
                        implementation("org.jetbrains.kotlinx:kotlinx-coroutines-core:1.7.3")
                        implementation("org.jetbrains.kotlinx:kotlinx-serialization-json:1.6.0")
                        implementation("org.jetbrains.kotlinx:kotlinx-datetime:0.4.1")
                        implementation("io.ktor:ktor-client-core:2.3.5")
                        implementation("io.ktor:ktor-client-content-negotiation:2.3.5")
                        implementation("io.ktor:ktor-serialization-kotlinx-json:2.3.5")
                        implementation("io.ktor:ktor-client-logging:2.3.5")
                    }
                }

                val jvmMain by getting {
                    dependencies {
                        implementation(compose.desktop.currentOs)
                        implementation(compose.material3)
                        implementation(compose.materialIconsExtended)
                        implementation("io.ktor:ktor-client-okhttp:2.3.5")
                        implementation("org.slf4j:slf4j-simple:2.0.9")
                        implementation("com.github.ajalt.clikt:clikt:4.2.1")
                    }
                }
            }
        }

        compose.desktop {
            application {
                mainClass = "com.jtools.jellyfin.gui.MainKt"
                nativeDistributions {
                    targetFormats(
                        org.jetbrains.compose.desktop.application.dsl.TargetFormat.Dmg,
                        org.jetbrains.compose.desktop.application.dsl.TargetFormat.Msi,
                        org.jetbrains.compose.desktop.application.dsl.TargetFormat.Deb
                    )
                    packageName = "jellyfin-tools"
                    packageVersion = "1.0.0"
                    description = "Jellyfinå·¥å…·ç®± - AIé©±åŠ¨çš„è·¨æœåŠ¡å™¨æ•°æ®è¿ç§»å·¥å…·"
                    copyright = "Â© 2024 JTools Team. Created with Claude Code."
                    vendor = "JTools Team"
                }
            }
        }
        EOF
        
    - name: Build JAR
      run: ./gradlew jvmJar --no-daemon
      
    - name: Build executables (Unix)
      if: matrix.os != 'windows-latest'
      run: |
        # åˆ›å»ºGUIå¯æ‰§è¡Œè„šæœ¬
        cat > jellyfin-tools-gui << 'EOF'
        #!/bin/bash
        DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
        java -cp "$DIR/jtools-jvm-1.0.0.jar" com.jtools.jellyfin.gui.MainKt "$@"
        EOF
        chmod +x jellyfin-tools-gui
        
        # åˆ›å»ºCLIå¯æ‰§è¡Œè„šæœ¬
        cat > jellyfin-tools-cli << 'EOF'
        #!/bin/bash
        DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
        java -jar "$DIR/jtools-jvm-1.0.0.jar" "$@"
        EOF
        chmod +x jellyfin-tools-cli
        
    - name: Build executables (Windows)
      if: matrix.os == 'windows-latest'
      shell: cmd
      run: |
        echo @echo off > jellyfin-tools-gui.bat
        echo java -cp "%%~dp0jtools-jvm-1.0.0.jar" com.jtools.jellyfin.gui.MainKt %%* >> jellyfin-tools-gui.bat
        echo @echo off > jellyfin-tools-cli.bat
        echo java -jar "%%~dp0jtools-jvm-1.0.0.jar" %%* >> jellyfin-tools-cli.bat
        
    - name: Create distribution directory
      run: |
        mkdir -p dist/jtools-${{ matrix.platform }}
        
    - name: Copy files (Unix)
      if: matrix.os != 'windows-latest'
      run: |
        cp build/libs/jtools-jvm-1.0.0.jar dist/jtools-${{ matrix.platform }}/
        cp jellyfin-tools-gui dist/jtools-${{ matrix.platform }}/
        cp jellyfin-tools-cli dist/jtools-${{ matrix.platform }}/
        cp README.md dist/jtools-${{ matrix.platform }}/
        cp jellyfin-config.example.json dist/jtools-${{ matrix.platform }}/
        
    - name: Copy files (Windows)
      if: matrix.os == 'windows-latest'
      shell: cmd
      run: |
        mkdir "dist\jtools-${{ matrix.platform }}"
        copy "build\libs\jtools-jvm-1.0.0.jar" "dist\jtools-${{ matrix.platform }}\"
        copy "jellyfin-tools-gui.bat" "dist\jtools-${{ matrix.platform }}\"
        copy "jellyfin-tools-cli.bat" "dist\jtools-${{ matrix.platform }}\"
        copy "README.md" "dist\jtools-${{ matrix.platform }}\"
        copy "jellyfin-config.example.json" "dist\jtools-${{ matrix.platform }}\"
        
    - name: Create archive (Linux)
      if: matrix.platform == 'linux'
      run: |
        cd dist
        tar -czf jtools-${{ matrix.platform }}.tar.gz jtools-${{ matrix.platform }}/
        
    - name: Create archive (Windows/macOS)
      if: matrix.platform != 'linux'
      run: |
        cd dist
        if [ "${{ matrix.platform }}" = "windows" ]; then
          powershell "Compress-Archive -Path 'jtools-${{ matrix.platform }}' -DestinationPath 'jtools-${{ matrix.platform }}.zip'"
        else
          zip -r jtools-${{ matrix.platform }}.zip jtools-${{ matrix.platform }}/
        fi
        
    - name: Upload Release Asset (Linux)
      if: matrix.platform == 'linux'
      uses: ncipollo/release-action@v1
      with:
        tag: ${{ needs.create-release.outputs.version }}
        artifacts: "./dist/jtools-${{ matrix.platform }}.tar.gz"
        token: ${{ secrets.GITHUB_TOKEN }}
        allowUpdates: true
        omitBodyDuringUpdate: true
        omitNameDuringUpdate: true
        
    - name: Upload Release Asset (Windows/macOS)
      if: matrix.platform != 'linux'
      uses: ncipollo/release-action@v1
      with:
        tag: ${{ needs.create-release.outputs.version }}
        artifacts: "./dist/jtools-${{ matrix.platform }}.zip"
        token: ${{ secrets.GITHUB_TOKEN }}
        allowUpdates: true
        omitBodyDuringUpdate: true
        omitNameDuringUpdate: true

  build-native-packages:
    needs: create-release
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Build native packages
      run: |
        ./gradlew packageDistributionForCurrentOS
        
    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi
        
    - name: Upload universal JAR
      uses: ncipollo/release-action@v1
      with:
        tag: ${{ steps.get_version.outputs.VERSION }}
        artifacts: "./build/libs/jtools-jvm-1.0.0.jar"
        token: ${{ secrets.GITHUB_TOKEN }}
        allowUpdates: true
        omitBodyDuringUpdate: true
        omitNameDuringUpdate: true