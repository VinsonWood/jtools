name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      release_id: ${{ steps.create_release.outputs.id }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi
        
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.get_version.outputs.VERSION }}
        release_name: "Jellyfinå·¥å…·ç®± ${{ steps.get_version.outputs.VERSION }}"
        body: |
          ## ðŸš€ Jellyfinå·¥å…·ç®± ${{ steps.get_version.outputs.VERSION }}
          
          ðŸ¤– **æœ¬ç‰ˆæœ¬ç”± Claude Code åˆ›å»º** - ä½¿ç”¨ AI åŠ©æ‰‹è¿›è¡Œå®Œæ•´å¼€å‘
          
          ### ðŸ“¦ ä¸‹è½½
          
          - **Windows**: ä¸‹è½½ `jtools-windows.zip`
          - **macOS**: ä¸‹è½½ `jtools-macos.zip` 
          - **Linux**: ä¸‹è½½ `jtools-linux.zip`
          - **é€šç”¨JAR**: ä¸‹è½½ `jtools-${{ steps.get_version.outputs.VERSION }}.jar`
          
          ### ðŸŽ¯ ä¸»è¦åŠŸèƒ½
          
          - ðŸŽ¬ å¯¼å…¥å¯¼å‡ºJellyfinå–œçˆ±çš„ç”µå½±å’Œæ¼”å‘˜
          - ðŸ”„ è·¨æœåŠ¡å™¨æ™ºèƒ½è¿ç§»
          - ðŸ” é‡å¤ç”µå½±æ£€æµ‹å’Œç®¡ç†
          - ðŸ‘ï¸ å¯¼å‡ºå†…å®¹å¯è§†åŒ–é¢„è§ˆ
          - ðŸ“± é«˜åˆ†è¾¨çŽ‡å±å¹•å®Œç¾Žé€‚é…
          - ðŸŒ è·¨å¹³å°æ”¯æŒ (Windows, macOS, Linux)
          
          ### ðŸ› ï¸ æŠ€æœ¯ç‰¹è‰²
          
          - Kotlin Multiplatform æž¶æž„
          - Compose Desktop çŽ°ä»£UI
          - Material Design 3 è®¾è®¡è¯­è¨€
          - AI é©±åŠ¨çš„ä»£ç è´¨é‡
          
          ### ðŸš¦ ä½¿ç”¨æ–¹æ³•
          
          #### GUIç‰ˆæœ¬ï¼ˆæŽ¨èï¼‰
          ```bash
          # è§£åŽ‹åŽè¿è¡Œ
          ./jellyfin-tools-gui
          ```
          
          #### CLIç‰ˆæœ¬
          ```bash
          # æµ‹è¯•è¿žæŽ¥
          ./jellyfin-tools-cli test -s http://your-server:8096 -t your-token
          
          # å¯¼å‡ºæ•°æ®
          ./jellyfin-tools-cli export -s http://your-server:8096 -t your-token -o favorites.json
          
          # å¯¼å…¥æ•°æ®
          ./jellyfin-tools-cli import -s http://your-server:8096 -t your-token -i favorites.json
          ```
          
          ---
          
          **å®Œæ•´æ–‡æ¡£**: [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
          
          **åé¦ˆé—®é¢˜**: [Issues](https://github.com/${{ github.repository }}/issues)
        draft: false
        prerelease: false

  build-cross-platform:
    needs: create-release
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            platform: linux
            executable-suffix: ""
            archive-suffix: "tar.gz"
          - os: windows-latest
            platform: windows
            executable-suffix: ".exe"
            archive-suffix: "zip"
          - os: macos-latest
            platform: macos
            executable-suffix: ""
            archive-suffix: "zip"
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Grant execute permission for gradlew (Unix)
      if: matrix.os != 'windows-latest'
      run: chmod +x gradlew
      
    - name: Build JAR
      run: ./gradlew jvmJar
      
    - name: Build executables (Unix)
      if: matrix.os != 'windows-latest'
      run: |
        chmod +x build-gui.sh
        ./build-gui.sh
        
    - name: Build executables (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        .\gradlew.bat jvmJar
        echo "@echo off" > jellyfin-tools-gui.bat
        echo "java -cp \"%~dp0build\libs\jtools-jvm-1.0.0.jar\" com.jtools.jellyfin.gui.MainKt %*" >> jellyfin-tools-gui.bat
        echo "@echo off" > jellyfin-tools-cli.bat
        echo "java -jar \"%~dp0build\libs\jtools-jvm-1.0.0.jar\" %*" >> jellyfin-tools-cli.bat
        
    - name: Create distribution directory
      run: |
        mkdir -p dist/jtools-${{ matrix.platform }}
        
    - name: Copy files (Unix)
      if: matrix.os != 'windows-latest'
      run: |
        cp build/libs/*.jar dist/jtools-${{ matrix.platform }}/
        cp jellyfin-tools-gui dist/jtools-${{ matrix.platform }}/
        cp jellyfin-tools-cli dist/jtools-${{ matrix.platform }}/
        cp README.md dist/jtools-${{ matrix.platform }}/
        cp jellyfin-config.example.json dist/jtools-${{ matrix.platform }}/
        
    - name: Copy files (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        copy "build\libs\*.jar" "dist\jtools-${{ matrix.platform }}\"
        copy "jellyfin-tools-gui.bat" "dist\jtools-${{ matrix.platform }}\"
        copy "jellyfin-tools-cli.bat" "dist\jtools-${{ matrix.platform }}\"
        copy "README.md" "dist\jtools-${{ matrix.platform }}\"
        copy "jellyfin-config.example.json" "dist\jtools-${{ matrix.platform }}\"
        
    - name: Create archive (Linux)
      if: matrix.platform == 'linux'
      run: |
        cd dist
        tar -czf jtools-${{ matrix.platform }}.tar.gz jtools-${{ matrix.platform }}/
        
    - name: Create archive (Windows/macOS)
      if: matrix.platform != 'linux'
      uses: thedoctor0/zip-action@v1
      with:
        type: 'zip'
        filename: 'jtools-${{ matrix.platform }}.zip'
        directory: 'dist'
        path: 'jtools-${{ matrix.platform }}'
        
    - name: Upload Release Asset (Linux)
      if: matrix.platform == 'linux'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-release.outputs.upload_url }}
        asset_path: ./dist/jtools-${{ matrix.platform }}.tar.gz
        asset_name: jtools-${{ matrix.platform }}.tar.gz
        asset_content_type: application/gzip
        
    - name: Upload Release Asset (Windows/macOS)
      if: matrix.platform != 'linux'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-release.outputs.upload_url }}
        asset_path: ./dist/jtools-${{ matrix.platform }}.zip
        asset_name: jtools-${{ matrix.platform }}.zip
        asset_content_type: application/zip

  build-native-packages:
    needs: create-release
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Build native packages
      run: |
        ./gradlew packageDistributionForCurrentOS
        
    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi
        
    - name: Upload universal JAR
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-release.outputs.upload_url }}
        asset_path: ./build/libs/jtools-jvm-1.0.0.jar
        asset_name: jtools-${{ steps.get_version.outputs.VERSION }}.jar
        asset_content_type: application/java-archive